<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="library">
	<!-- parameter에 도서관 번호/ 페이지 번호  -->

	
	<select id="selectStudyRoomList" parameterType="java.util.Map" resultType="studyRoomVO">
		select l_id, sr_num, sr_title, m_name, sr_date, sr_cate, sr_view_num 
		from (select rownum r, imsi_t.* 
			from (select l_id, sr_num, sr_cate, sr_title, m_name, sr_date, sr_view_num 
					from l_member m, studyroom s 
					where s.m_id=m.m_id and l_id like #{map_l_id} 
					order by sr_date desc) imsi_t) 
		where r between #{map_start_rownum} and #{map_end_rownum} 
	</select>
	
	<select id="selectStudyRoomAllCnt" resultType="int">
		select count(*) from studyroom
	</select> 
	
	
	<select id="selectStudyRoomSearch" parameterType="java.util.Map" resultType="studyRoomVO">
		select l_id, sr_num, sr_title, m_name, sr_date, sr_cate, sr_view_num 
		from (select rownum r, imsi_t.* 
			from (select l_id, sr_num, sr_cate, sr_title, m_name, sr_date, sr_view_num 
					from l_member m, studyroom s 
					where s.m_id=m.m_id and l_id like #{map_l_id} 
					<if test="map_sr_type=='제목'">
						and sr_title like '%'||#{map_sr_word}||'%' 
					</if>
					<if test="map_sr_type=='카테고리'">
						and sr_cate like '%'||#{map_sr_word}||'%'
					</if>
						and (to_date(to_char(sysdate, 'YY/MM/DD'))-to_date(sr_date)) between 0 and #{map_sr_date} 
					order by sr_date desc) imsi_t) 
		where r between #{map_start_rownum} and #{map_end_rownum} <if test="map_sr_type=='작성자'">and m_name like '%'||#{map_sr_word}||'%'</if>
	</select>
	
	<select id="selectStudyRoomSearchCnt" parameterType="java.util.Map" resultType="int">
		select count(*)
		from (
				select m_name
				from l_member m, studyroom s  
				where s.m_id=m.m_id and l_id like #{map_l_id} 
					<if test="map_sr_type=='제목'">
						and sr_title like '%'||#{map_sr_word}||'%' 
					</if>
					<if test="map_sr_type=='카테고리'">
						and sr_cate like '%'||#{map_sr_word}||'%' 
					</if>
			 			and (to_date(to_char(sysdate, 'YY/MM/DD'))-to_date(sr_date)) between 0 and #{map_sr_date} 
			 )
		<if test="map_sr_type=='작성자'">where m_name like '%'||#{map_sr_word}||'%'</if>	
	</select>

	<select id="selectStudyRoomDetail" parameterType="java.util.Map" resultType="studyRoomVO">
		select m_name, s.* 
		from l_member m, studyroom s 
		where s.m_id=m.m_id and sr_num=#{map_sr_num} 
	</select>

	<insert id="insertStudyRoomWrite" parameterType="studyRoomVO">
		insert into studyroom values (sr_num.nextval, #{sr_title}, #{l_id}, #{sr_content}, #{m_id}, #{sr_pw}, sysdate, #{sr_cate}, 0)
	</insert>


	<!-- 그냥 댓글 입력시  -->
	<insert id="insertStudyRoomCommentWrite" parameterType="studyRoomCommentVO">
		insert into sr_comment values (#{sr_num}, sr_comment_num.nextval, #{sr_comment_id}, sysdate, #{sr_comment_content}, -1)
	</insert>
	
	<!-- 댓글의 댓글 입력시 -->
	<insert id="insertStudyRoomReCommentWrite" parameterType="studyRoomCommentVO">
		insert into sr_recomment values (#{sr_num}, #{sr_comment_num}, sr_recomment_num.nextval, #{sr_comment_id}, sysdate, #{sr_comment_content})
	</insert>

	<update id="updateStudyRoomCommentRecommentFlag" parameterType="java.util.Map" >
		update sr_comment set sr_recomment_flag=1 where sr_num=#{map_sr_num} and sr_comment_num=#{map_sr_comment_num}
	</update>
	
	
	<select id="selectStudyRoomRecommentList" parameterType="java.util.Map" resultType="studyRoomCommentVO">
		select * 
		from sr_recomment 
		where sr_num=#{map_sr_num} and sr_comment_num=#{map_sr_comment_num} 
		order by sr_comment_date asc 
	</select>
	<select id="selectStudyRoomReCommentAddList" parameterType="java.util.Map" resultType="studyRoomCommentVO">
		select *  
		from (
			select rownum r, imsi_t.*   
			from (
					select * 
					from sr_recomment 
					where sr_num=#{map_sr_num} and sr_comment_num=#{map_sr_comment_num} 
					order by sr_comment_date asc 
			) imsi_t
		)
		where r between #{map_start_rownum} and #{map_end_rownum}
	</select>
	
	
	
	<!-- 글 들어갔을 때 댓글보기 -->
	<select id="selectStudyRoomCommentList" parameterType="java.util.Map" resultType="studyRoomCommentVO">
		select *  
		from (
			select rownum r, imsi_t.*   
			from (
				select * from sr_comment where sr_num=#{map_sr_num} order by sr_comment_date asc
			) imsi_t
		)
		where r between #{map_start_rownum} and #{map_end_rownum}
	</select>
	
	
<!-- 	<select id="selectStudyRoomCommentList" parameterType="java.util.Map" resultType="studyRoomCommentVO">
		select * 
		from
			(select rownum r, imsi_t.*
			from (	select * 
					from ( select * from sr_recomment where sr_num=#{map_sr_num} union all
							select sr_num, sr_comment_num, -1 as sr_recomment_num, sr_comment_id, sr_comment_date, sr_comment_content from sr_comment where sr_num=#{map_sr_num} )
					order by sr_comment_num asc, sr_comment_date asc 
			) imsi_t 
		)
		where r between #{map_start_rownum} and #{map_end_rownum}
	</select>
	 -->

	<select id="selectStudyRoomCommentCnt" parameterType="java.util.Map" resultType="int">
		select count(*) from sr_comment where sr_num=#{map_sr_num}
	</select>
	
	<update id="updateStudyRoomViewNum" parameterType="java.util.Map" >
		update studyroom set sr_view_num=sr_view_num+1 where sr_num=#{map_sr_num}
	</update>




	<select id="selectCntMakeStudyRoomWithId" parameterType="String" resultType="int">
		select count(*) from studyroom where m_id=#{map_m_id}
	</select>

	<select id="selectListMakeStudyRoomWithId" parameterType="java.util.Map" resultType="studyRoomVO">
		select l_id, sr_num, sr_title, m_name, sr_date, sr_cate, sr_view_num 
		from (select rownum r, imsi_t.* 
			from (select l_id, sr_num, sr_cate, sr_title, m_name, sr_date, sr_view_num 
					from l_member m, studyroom s 
					where s.m_id=m.m_id and l_id like #{map_l_id} and s.m_id=#{map_m_id} 
					order by sr_date desc) imsi_t) 
		where r between #{map_start_rownum} and #{map_end_rownum} 
	</select>

	
</mapper>
